name: Reusable Issue Triage

on:
  workflow_call:
    inputs:
      runner:
        description: 'Runner to use (leave empty for auto-detect)'
        type: string
        default: ''
      enable_dedupe:
        description: 'Enable duplicate detection'
        type: boolean
        default: true
    secrets:
      OPENAI_API_KEY:
        required: true
      OPENAI_BASE_URL:
        required: false
      CODEX_MODEL:
        required: false
      CODEX_REASONING_EFFORT:
        required: false

jobs:
  label:
    name: Issue Label
    runs-on: ${{ inputs.runner != '' && inputs.runner || (github.repository_visibility == 'private' && fromJSON('["self-hosted", "linux", "x64"]') || 'ubuntu-latest') }}
    container:
      image: node:20-bullseye
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout prompts
        uses: actions/checkout@v4
        with:
          repository: MonteYin/codex-actions
          path: .codex-actions
          sparse-checkout: .github/prompts

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Run Codex Labeler
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          CODEX_HOME: ${{ runner.temp }}/codex-home
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          REPOSITORY: ${{ github.repository }}
        shell: bash
        run: |
          mkdir -p "$CODEX_HOME"
          MODEL="${{ secrets.CODEX_MODEL }}"
          MODEL="${MODEL:-gpt-5.2}"
          EFFORT="${{ secrets.CODEX_REASONING_EFFORT }}"
          EFFORT="${EFFORT:-xhigh}"
          cat > "$CODEX_HOME/config.toml" << TOML
          model = "$MODEL"
          model_reasoning_effort = "$EFFORT"
          TOML
          echo "{\"OPENAI_API_KEY\": \"${{ secrets.OPENAI_API_KEY }}\"}" > "$CODEX_HOME/auth.json"

          PROMPT=$(cat .codex-actions/.github/prompts/issue-label.md)
          PROMPT="${PROMPT//\$\{ISSUE_NUMBER\}/$ISSUE_NUMBER}"
          PROMPT="${PROMPT//\$\{ISSUE_TITLE\}/$ISSUE_TITLE}"
          PROMPT="${PROMPT//\$\{REPOSITORY\}/$REPOSITORY}"
          codex exec --full-auto --output-last-message /tmp/codex-output.json "$PROMPT" || true

      - name: Apply Label
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        with:
          script: |
            const fs = require('fs');

            const labels = [
              { name: 'bug', description: "Something isn't working", color: 'd73a4a' },
              { name: 'enhancement', description: 'New feature or request', color: 'a2eeef' },
              { name: 'question', description: 'Questions or clarification requests', color: 'd876e3' },
              { name: 'documentation', description: 'Documentation improvements', color: '0075ca' },
              { name: 'help-wanted', description: 'Extra attention is needed', color: '008672' }
            ];

            for (const label of labels) {
              try {
                await github.rest.issues.getLabel({ owner: context.repo.owner, repo: context.repo.repo, name: label.name });
              } catch (e) {
                if (e.status === 404) {
                  await github.rest.issues.createLabel({ owner: context.repo.owner, repo: context.repo.repo, ...label });
                }
              }
            }

            if (!fs.existsSync('/tmp/codex-output.json')) return;
            const output = fs.readFileSync('/tmp/codex-output.json', 'utf8').trim();
            if (!output) return;

            let result;
            try { result = JSON.parse(output); } catch (e) { return; }

            const label = result.label;
            const validLabels = ['bug', 'enhancement', 'question', 'documentation', 'help-wanted'];
            if (!label || !validLabels.includes(label)) return;

            await github.rest.issues.addLabels({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: parseInt(process.env.ISSUE_NUMBER),
              labels: [label]
            });

  deduplicate:
    name: Issue Dedupe
    needs: label
    if: inputs.enable_dedupe
    runs-on: ${{ inputs.runner != '' && inputs.runner || (github.repository_visibility == 'private' && fromJSON('["self-hosted", "linux", "x64"]') || 'ubuntu-latest') }}
    container:
      image: node:20-bullseye
    timeout-minutes: 15
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout prompts
        uses: actions/checkout@v4
        with:
          repository: MonteYin/codex-actions
          path: .codex-actions
          sparse-checkout: .github/prompts

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          apt-get update && apt-get install -y jq curl
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          apt-get update && apt-get install -y gh
          npm install -g @openai/codex

      - name: Prepare Issue Context
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue list --repo "${{ github.repository }}" --json number,title,body,createdAt --limit 1000 --state all --search "sort:created-desc" | jq '.' > codex-existing-issues.json
          gh issue view "${{ github.event.issue.number }}" --repo "${{ github.repository }}" --json number,title,body | jq '.' > codex-current-issue.json

      - name: Run Codex Deduplicator
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          CODEX_HOME: ${{ runner.temp }}/codex-home
        run: |
          mkdir -p "$CODEX_HOME"
          MODEL="${{ secrets.CODEX_MODEL }}"
          MODEL="${MODEL:-gpt-5.2}"
          EFFORT="${{ secrets.CODEX_REASONING_EFFORT }}"
          EFFORT="${EFFORT:-xhigh}"
          cat > "$CODEX_HOME/config.toml" << TOML
          model = "$MODEL"
          model_reasoning_effort = "$EFFORT"
          TOML
          echo "{\"OPENAI_API_KEY\": \"${{ secrets.OPENAI_API_KEY }}\"}" > "$CODEX_HOME/auth.json"

          PROMPT=$(cat .codex-actions/.github/prompts/issue-dedupe.md)
          codex exec --full-auto --output-last-message /tmp/codex-output.json "$PROMPT" || true

      - name: Handle Duplicates
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        with:
          script: |
            const fs = require('fs');

            try {
              await github.rest.issues.getLabel({ owner: context.repo.owner, repo: context.repo.repo, name: 'duplicate' });
            } catch (e) {
              if (e.status === 404) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner, repo: context.repo.repo,
                  name: 'duplicate', description: 'Duplicate of existing issue', color: 'cfd3d7'
                });
              }
            }

            if (!fs.existsSync('/tmp/codex-output.json')) return;
            const output = fs.readFileSync('/tmp/codex-output.json', 'utf8').trim();
            if (!output) return;

            let result;
            try { result = JSON.parse(output); } catch (e) { return; }

            const currentIssue = parseInt(process.env.ISSUE_NUMBER);
            const duplicates = (result.issues || []).map(n => parseInt(n)).filter(n => !isNaN(n) && n !== currentIssue);
            if (duplicates.length === 0) return;

            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: currentIssue,
              body: `Duplicate issue detected. Closing.\n\n${duplicates.map(n => `- #${n}`).join('\n')}\n\n_Reason: ${result.reason || 'Similar content detected'}_`
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: currentIssue, labels: ['duplicate']
            });

            await github.rest.issues.update({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: currentIssue,
              state: 'closed', state_reason: 'not_planned'
            });
