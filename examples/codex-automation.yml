# Codex GitHub Automation - Full Setup
# Copy to: .github/workflows/codex.yml
#
# Required secrets:
#   - OPENAI_API_KEY
# Optional secrets:
#   - OPENAI_BASE_URL
#   - CODEX_MODEL (default: gpt-5.2)
#   - CODEX_REASONING_EFFORT (default: xhigh)

name: Codex Automation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issues:
    types: [opened]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # PR Review - AI code review with inline comments
  pr-review:
    if: github.event_name == 'pull_request'
    uses: MonteYin/codex-actions/.github/workflows/reusable-pr-review.yml@v1
    secrets: inherit

  # PR Label - Auto-label PRs based on content
  pr-label:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    uses: MonteYin/codex-actions/.github/workflows/reusable-pr-label.yml@v1
    secrets: inherit

  # PR Description - Auto-enhance PR descriptions
  pr-description:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    uses: MonteYin/codex-actions/.github/workflows/reusable-pr-description.yml@v1
    secrets: inherit

  # Issue Label + Issue Dedupe - Classification and duplicate detection
  issue-triage:
    if: github.event_name == 'issues'
    uses: MonteYin/codex-actions/.github/workflows/reusable-issue-triage.yml@v1
    with:
      enable_dedupe: true
    secrets: inherit

  # Issue Response - Auto-respond to new issues
  issue-response:
    if: github.event_name == 'issues'
    uses: MonteYin/codex-actions/.github/workflows/reusable-issue-auto-response.yml@v1
    secrets: inherit

  # Mention Response - Respond to @codex mentions
  # Security: Only OWNER/MEMBER/COLLABORATOR can trigger, Bots excluded
  mention-response:
    if: >-
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      contains(github.event.comment.body, '@codex') &&
      github.event.sender.type != 'Bot' &&
      (github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'COLLABORATOR')
    uses: MonteYin/codex-actions/.github/workflows/reusable-mention-responder.yml@v1
    secrets: inherit

  # Issue Stale Cleanup - Clean up inactive issues
  issue-stale-cleanup:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    uses: MonteYin/codex-actions/.github/workflows/reusable-issue-stale-cleanup.yml@v1
    secrets: inherit
